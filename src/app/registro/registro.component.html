<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
  <div class="container px-5">
    <a class="navbar-brand fw-bold" href="#">
      <img src="assets/img/lealtix_logo_transp.png" alt="Lealtix Logo" width="40" height="40" class="me-2" />
      Lealtix
    </a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
      aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
        <li class="nav-item"><a class="nav-link" href="/">Inicio</a></li>
        <li class="nav-item"><a class="nav-link" href="#">Beneficios</a></li>
        <li class="nav-item"><a class="nav-link" href="#">Precios</a></li>
        <li class="nav-item"><a class="nav-link" href="#">Contacto</a></li>
      </ul>
    </div>
  </div>
</nav>

<!-- Loading Screen -->
<div *ngIf="loading" class="loading-screen">
  <div class="loading-content">
    <p-progressSpinner strokeWidth="3" fill="transparent" animationDuration="1s"></p-progressSpinner>
    <h3 class="loading-title">Validando invitación...</h3>
    <p class="loading-subtitle">Por favor espera un momento</p>
  </div>
</div>

<!-- Registro con Stepper -->
<section class="registration-section" *ngIf="!loading">
  <div class="registration-container">
    <div class="registration-card">

      <!-- Header del formulario -->
      <div class="registration-header">
        <div class="brand-section">
          <div>
            <h2 class="brand-title">Bienvenido a Lealtix</h2>
            <p class="brand-subtitle">Completa tu registro para comenzar</p>
          </div>
        </div>
      </div>
      <app-confetti></app-confetti>

      <!-- Stepper -->
      <div class="stepper-container">
        <!-- Navigation (custom styled steps with rounded gold numbers) -->
        <div class="custom-steps" role="tablist" aria-label="Registro Steps">
          <div *ngFor="let item of stepItems; let i = index" class="custom-step" [class.active]="i === activeStep" [class.completed]="i < activeStep" [class.blocked]="paymentConfirmed && i < 2" (click)="onStepClick(i)">
            <div class="custom-step-number">{{ i < activeStep ? '✓' : (i + 1) }}</div>
            <div class="custom-step-info">
              <div class="custom-step-title">{{ item.label }}</div>
              <div class="custom-step-desc">{{ item.label | lowercase }}</div>
            </div>
          </div>
        </div>

        <!-- Panels controlled by activeStep -->
        <!-- Step 1: Información Personal -->
        <div *ngIf="activeStep === 0" class="step-content">
          <div class="step-header">
            <h3 class="step-title">
              <i class="pi pi-user step-icon"></i>
              Información Personal
            </h3>
            <p class="step-description">Completa tus datos básicos para continuar</p>
          </div>

          <form [formGroup]="registroForm" class="step-form">
            <div formGroupName="tenant">
              <div class="form-grid">
                <!-- Nombre Completo -->
                <div class="form-field">
                  <label for="fullName" class="field-label">
                    Nombre completo <span class="required">*</span>
                  </label>
                  <input
                    id="fullName"
                    pInputText
                    formControlName="fullName"
                    class="w-full"
                    [class.p-invalid]="isFieldInvalid('fullName')"
                    placeholder="Ingresa tu nombre completo"
                  />
                  <small *ngIf="isFieldInvalid('fullName')" class="p-error">
                    <i class="pi pi-exclamation-circle"></i> El nombre es requerido
                  </small>
                </div>

                <!-- Fecha de Nacimiento -->
                <div class="form-field">
                  <label for="fechaNacimiento" class="field-label">
                    Fecha de nacimiento <span class="required">*</span>
                  </label>
                  <input
                    id="fechaNacimiento"
                    pInputText
                    type="date"
                    formControlName="fechaNacimiento"
                    class="w-full"
                    [class.p-invalid]="isFieldInvalid('fechaNacimiento')"
                  />
                  <small *ngIf="tenant['fechaNacimiento'].hasError('required') && isFieldInvalid('fechaNacimiento')" class="p-error">
                    <i class="pi pi-exclamation-circle"></i> La fecha de nacimiento es requerida
                  </small>
                  <small *ngIf="tenant['fechaNacimiento'].hasError('minAge') && isFieldInvalid('fechaNacimiento')" class="p-error">
                    <i class="pi pi-exclamation-circle"></i> Debes tener al menos 18 años
                  </small>
                  <small *ngIf="tenant['fechaNacimiento'].hasError('invalidDate') && isFieldInvalid('fechaNacimiento')" class="p-error">
                    <i class="pi pi-exclamation-circle"></i> Fecha inválida
                  </small>
                </div>

                      <!-- Email -->
                      <div class="form-field full-col">
                  <label for="email" class="field-label">
                    Correo electrónico <span class="required">*</span>
                  </label>
                  <input
                    pInputText
                    id="email"
                    type="email"
                    formControlName="email"
                    class="w-full"
                    [class.p-invalid]="isFieldInvalid('email')"
                    placeholder="ejemplo@correo.com"
                  />
                  <small *ngIf="isFieldInvalid('email')" class="p-error">
                    <i class="pi pi-exclamation-circle"></i> Ingresa un email válido
                  </small>
                </div>

                <!-- Teléfono -->
                <div class="form-field">
                  <label for="telefono" class="field-label">
                    Número de teléfono
                  </label>
                  <p-inputNumber
                    id="telefono"
                    formControlName="telefono"
                    class="w-full"
                    placeholder="10 dígitos"
                    [useGrouping]="false"
                    [maxlength]="10"
                    [min]="1000000000"
                    [max]="9999999999"
                    mode="decimal"
                  ></p-inputNumber>
                  <small class="field-help">
                    <i class="pi pi-info-circle"></i> Formato: 5512345678
                  </small>
                </div>

                      <!-- Contraseña -->
                      <div class="form-field">
                  <label for="password" class="field-label">
                    Contraseña <span class="required">*</span>
                  </label>
                  <div class="password-field">
                    <input
                      id="password"
                      [type]="showPassword ? 'text' : 'password'"
                      pInputText
                      formControlName="password"
                      class="password-input"
                      [class.p-invalid]="isFieldInvalid('password')"
                      placeholder="Crea una contraseña segura"
                    />
                    <button
                      type="button"
                      class="password-toggle"
                      (click)="togglePasswordVisibility()"
                    >
                      <i [class]="showPassword ? 'pi pi-eye-slash' : 'pi pi-eye'"></i>
                    </button>
                  </div>
                  <small *ngIf="isFieldInvalid('password')" class="p-error">
                    <i class="pi pi-exclamation-circle"></i> La contraseña es requerida
                  </small>
                </div>
              </div>
            </div>
          </form>

          <div class="privacy-notice">
            <i class="pi pi-shield"></i>
            <p>Al registrarte aceptas recibir promociones del negocio. Tus datos están protegidos y no se comparten con terceros. <br><a [routerLink]="['/privacy']">Ver Aviso de Privacidad</a></p>
          </div>

          <div class="step-actions">
            <!-- Use PrimeNG styleClass so the rendered button element receives these classes -->
            <p-button
              label="Continuar"
              icon="pi pi-arrow-right"
              iconPos="right"
              styleClass="primary-button full-width"
              (onClick)="nextStep()"
              [loading]="isValidating"
            ></p-button>
          </div>
        </div>

        <!-- Step 2: Método de Pago -->
        <div *ngIf="activeStep === 1" class="step-content">
          <div class="step-header">
            <h3 class="step-title">
              <i class="pi pi-credit-card step-icon"></i>
              Método de Pago
            </h3>
            <p class="step-description">Configura tu método de pago para completar el registro</p>
          </div>

          <!-- Payment Element Container -->
          <div class="payment-section">
            <div class="payment-element-container" style="position:relative">
              <div id="payment-element">
              </div>
              <div *ngIf="paymentElementLoading" class="payment-loading-overlay">
                <div class="overlay-content">
                  <p-progressSpinner strokeWidth="3" fill="transparent" animationDuration="1s"></p-progressSpinner>
                  <p>Cargando método de pago seguro...</p>
                </div>
              </div>

              <div *ngIf="paymentError" class="payment-error" style="margin-top:1rem">
                <i class="pi pi-exclamation-triangle"></i>
                <span class="friendly-message">{{ paymentError }}</span>

                <button
                  type="button"
                  class="details-toggle p-button p-component p-button-text"
                  *ngIf="paymentErrorDetails"
                  (click)="showErrorDetails = !showErrorDetails"
                  style="margin-left:0.75rem"
                >
                  <span class="p-button-label">{{ showErrorDetails ? 'Ocultar detalles' : 'Ver detalles' }}</span>
                </button>

                <div *ngIf="showErrorDetails && paymentErrorDetails" class="error-details" style="margin-top:0.75rem; font-size:0.9rem; color:#6b7280">
                  <div *ngIf="paymentErrorDetails.stripeMessage"><strong>Mensaje:</strong> {{ paymentErrorDetails.stripeMessage }}</div>
                  <div *ngIf="paymentErrorDetails.code"><strong>Código:</strong> {{ paymentErrorDetails.code }}</div>
                  <div *ngIf="paymentErrorDetails.decline_code"><strong>Decline code:</strong> {{ paymentErrorDetails.decline_code }}</div>
                  <div *ngIf="paymentErrorDetails.paymentIntentId"><strong>PaymentIntent:</strong> {{ paymentErrorDetails.paymentIntentId }}</div>
                </div>
                </div>
                <div *ngIf="paymentFailed" style="margin-top:0.5rem; font-size:0.85rem; color:#374151">
                  <small>Nota: al reintentar el pago el formulario de tarjeta puede reiniciarse si es necesario. Si quieres probar con otra tarjeta, rellena los datos y presiona "Reintentar pago".</small>
                </div>
            </div>
          </div>

          <div class="step-actions">
            <p-button
              label="Anterior"
              icon="pi pi-arrow-left"
              iconPos="left"
              class="secondary-button"
              (onClick)="previousStep()"
              [disabled]="paymentConfirmed"
            ></p-button>

            <p-button
              [label]="paymentFailed ? 'Reintentar pago' : 'Procesar Pago'"
              [icon]="paymentFailed ? 'pi pi-refresh' : 'pi pi-check'"
              iconPos="right"
              class="primary-button"
              (onClick)="paymentFailed ? retryPayment() : processPayment()"
              [loading]="isProcessingPayment || retryInProgress"
              [disabled]="paymentElementLoading || isProcessingPayment || retryInProgress || (!stripeInitialized && !paymentFailed)"
            ></p-button>
          </div>
        </div>

  <!-- Step 3: Confirmación -->
  <div *ngIf="activeStep === 2" class="step-content">
          <div class="confirmation-content">
            <div class="success-icon">
              <i class="pi pi-check-circle"></i>
            </div>
            <h3 class="confirmation-title">¡Registro Completado!</h3>
            <p class="confirmation-message">
              Tu cuenta ha sido creada exitosamente y tu pago ha sido procesado.
              Ya puedes comenzar a usar Lealtix.
            </p>

            <div class="confirmation-details">
              <div class="detail-item">
                <i class="pi pi-user"></i>
                <span>{{ tenant['fullName'].value }}</span>
              </div>
              <div class="detail-item">
                <i class="pi pi-envelope"></i>
                <span>{{ tenant['email'].value }}</span>
              </div>
            </div>
            <div class="confirmation-note" style="margin-top:1rem; text-align:center;">
              <i class="pi pi-envelope" style="font-size:1.6rem;color:#0ea5a4;"></i>
              <p class="fs-6 mb-0 text-secondary" style="max-width:720px;margin:0.5rem auto 0;">
                En breve recibirás un correo electrónico con tus credenciales de acceso al panel de administración de tu página en Lealtix.
                <br>Sigue las instrucciones del correo para iniciar sesión y configurar tu cuenta. Si no lo recibes en unos minutos, revisa la carpeta de spam o promociones.
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- Success message is now rendered inline in Step 3 (no modal) -->

<!-- Footer -->
<footer class="footer">
  <div class="footer-content">
    <div class="footer-brand">
      <h5>Lealtix</h5>
    </div>
      <div class="footer-links">
      <a [routerLink]="['/']">Inicio</a>
      <a href="#">Beneficios</a>
      <a href="#">Precios</a>
      <a [routerLink]="['/privacy']">Aviso de Privacidad</a>
      <a href="#">Contacto</a>
    </div>
    <div class="footer-copyright">
      <p>© 2025 Lealtix. Todos los derechos reservados.</p>
    </div>
  </div>
</footer>
